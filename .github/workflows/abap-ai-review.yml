name: ABAP AI Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  # workflow_dispatch: {}  # æ‰‹å‹•å®Ÿè¡Œã—ãŸã„å ´åˆã¯æœ‰åŠ¹åŒ–

permissions:
  contents: read
  pull-requests: write
  issues: write   # ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ã«ä½¿ç”¨

jobs:
  review:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --- ABAPå·®åˆ†ã®åé›†ï¼ˆABAPæ‹¡å¼µå­ã«é™å®šï¼‰ ---
      - name: Collect ABAP diff
        shell: bash
        run: |
          set -euo pipefail
          git fetch origin "${{ github.base_ref }}" --depth=50
          git diff --unified=0 "origin/${{ github.base_ref }}...HEAD" \
            -- '*.abap' '*.prog.abap' '*.clas.abap' '*.intf.abap' '*.incl.abap' > diff.patch || true
          head -c 90000 diff.patch > diff.trunc.patch || true
          wc -c diff.trunc.patch || true

      # --- å·®åˆ†ãŒç„¡ã‘ã‚Œã°ã‚¹ã‚­ãƒƒãƒ— ---
      - name: Skip if no diff
        id: guard
        shell: bash
        run: |
          if [ ! -s diff.trunc.patch ]; then
            echo "No ABAP diff. Skipping review."
            echo "skip=true" >> "$GITHUB_OUTPUT"
          fi

      # --- PRãƒ¡ã‚¿æƒ…å ±ã®åé›† ---
      - name: Collect PR metadata
        if: steps.guard.outputs.skip != 'true'
        id: meta
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          REPO="${{ github.repository }}"
          NUM="${{ github.event.number }}"
          PR=$(gh api "repos/$REPO/pulls/$NUM")
          FILES_JSON=$(gh api "repos/$REPO/pulls/$NUM/files" -q '.[] | {filename, status}' | jq -c -s .)

          {
            echo "title<<__EOF__"
            echo "$PR" | jq -r '.title'
            echo "__EOF__"
            echo "body<<__EOF__"
            echo "$PR" | jq -r '.body // ""' | tr -d '\r'
            echo "__EOF__"
            echo "author<<__EOF__"
            echo "$PR" | jq -r '.user.login'
            echo "__EOF__"
            echo "changed_files<<__EOF__"
            echo "$FILES_JSON"
            echo "__EOF__"
          } >> "$GITHUB_OUTPUT"

      # --- Dify Workflow å®Ÿè¡Œ ---
      - name: Call Dify Workflow
        if: steps.guard.outputs.skip != 'true'
        id: dify
        env:
          DIFY_API_KEY: ${{ secrets.DIFY_API_KEY }}         # Dify Workflowç”¨ Server-side API Key
          DIFY_API_BASE: ${{ secrets.DIFY_API_BASE }}       # ä¾‹: https://dify-novagrid.com or https://dify-novagrid.com/v1
          DIFY_WORKFLOW_ID: ${{ secrets.DIFY_WORKFLOW_ID }} # ä¾‹: uNCqCaZfykMRl1r6
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -y && sudo apt-get install -y jq

          [ -n "${DIFY_WORKFLOW_ID:-}" ] || { echo "ERROR: DIFY_WORKFLOW_ID is empty."; exit 1; }

          # /v1 ã‚’è£œå®Œ
          _base="${DIFY_API_BASE%/}"
          if ! echo "$_base" | grep -q '/v1$'; then
            _base="$_base/v1"
          fi
          URL="$_base/workflows/run"
          echo "Call URL: $URL"

          # changed_files ã¯â€œæ–‡å­—åˆ—â€ã§æ¸¡ã™ï¼ˆDifyå´ï¼šæ®µè½ 32768ï¼‰
          BODY=$(jq -n \
            --arg wid   "${DIFY_WORKFLOW_ID}" \
            --arg diff  "$(cat diff.trunc.patch)" \
            --arg repo  "${{ github.repository }}" \
            --arg pr    "${{ github.event.number }}" \
            --arg user  "${{ github.actor }}" \
            --arg author "${{ steps.meta.outputs.author }}" \
            --arg title  "${{ steps.meta.outputs.title }}" \
            --arg bodytxt "${{ steps.meta.outputs.body }}" \
            --arg changed_files "${{ steps.meta.outputs.changed_files }}" \
            '{
               workflow_id: $wid,
               inputs: {
                 code_diff: $diff,
                 repo: $repo,
                 pr_number: ($pr|tonumber),
                 author: $author,
                 title: $title,
                 body: $bodytxt,
                 changed_files: $changed_files
               },
               response_mode: "blocking",
               user: $user
             }')

          # æœ¬æ–‡ã¨HTTPã‚³ãƒ¼ãƒ‰ã‚’ä¸¡å–ã‚Šã—ã¦è‡ªå‰åˆ¤å®š
          RESP=$(curl -sS -L -w "\n%{http_code}" \
            -H "Authorization: Bearer $DIFY_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$BODY" \
            "$URL" || true)

          HTTP_CODE=$(echo "$RESP" | tail -n1)
          JSON=$(echo "$RESP" | sed '$d')
          echo "HTTP_CODE=$HTTP_CODE"
          echo "$JSON" > dify.json

          # 2xx åˆ¤å®šã¯ãã®ã¾ã¾
          if ! echo "$HTTP_CODE" | grep -qE '^2'; then
            echo "(Dify error; HTTP_CODE=$HTTP_CODE)" > review_raw.json
            cat dify.json >> review_raw.json
          else
            # outputs.review ãŒã‚ã‚Œã°æœ€å„ªå…ˆã§å–ã‚Šå‡ºã—ã€‚ãªã‘ã‚Œã° outputs å…¨ä½“ or dify.json
            jq -r '
              if .data? and .data.outputs? and (.data.outputs.review? // empty) then
                .data.outputs.review
              elif .review? then
                .review
              elif .data? and .data.outputs? then
                .data.outputs
              else
                .
              end
            ' dify.json > review_raw.json
          fi


      - name: Format Dify output to Markdown
        if: steps.guard.outputs.skip != 'true'
        shell: bash
        run: |
          set -euo pipefail
          jq -r '
            def ensure_obj($x):
              if $x|type == "object" then $x
              elif $x|type == "string" then ( try ($x|fromjson) catch {"raw":$x} )
              else {"raw":($x|tostring)}
              end;
      
            . as $raw                         # â† input ã‚’ä½¿ã‚ãšã€ç¾åœ¨ã®å…¥åŠ›ã‚’ãã®ã¾ã¾ä½¿ã†
            | (ensure_obj($raw)) as $r
      
            | if ((($r.violations // [])|length) > 0
                  or (($r.improvements // [])|length) > 0
                  or (($r.notes // [])|length) > 0) then
      
                "### ğŸ¤– Dify ABAP ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ\n" +
      
                "\n#### ğŸš¨ é•å (Violations)\n" +
                ( if (($r.violations // [])|length) > 0 then
                    "| ãƒ«ãƒ¼ãƒ«ID | é‡å¤§åº¦ | å ´æ‰€ | å†…å®¹ |\n" +
                    "|----------|--------|------|------|\n" +
                    ( ($r.violations // [])[] |
                      "| " + (.rule_id|tostring) + " | " +
                      (if .severity=="block" then "âŒ block" else "âš ï¸ warn" end) + " | " +
                      .location + " | " + .message + " |"
                    )
                  else
                    "_No violations_\n"
                  end
                ) +
      
                "\n\n#### ğŸ›  æ”¹å–„ææ¡ˆ (Improvements)\n" +
                ( if (($r.improvements // [])|length) > 0 then
                    ( ($r.improvements // [])[]
                      | "**" + .title + "**\nèª¬æ˜: " + .explanation + "\n```abap\n" + .code + "\n```\n"
                    )
                  else
                    "_No suggestions_\n"
                  end
                ) +
      
                "\n#### ğŸ“ å‚™è€ƒ\n" +
                ( if (($r.notes // [])|length) > 0 then
                    ( ($r.notes // []) | map("- " + .) | join("\n") )
                  else
                    "_No notes_"
                  end
                )
      
              else
                "### ğŸ¤– Dify ABAP ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ\n\n```\n" + ($raw|tostring) + "\n```"
              end
          ' review_raw.json > review.md


      # --- PRã«ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ ---
      - name: Post PR comment
        if: steps.guard.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          gh api "repos/${{ github.repository }}/issues/${{ github.event.number }}/comments" \
            -f body="$(cat review.md)"
