#
name: ABAP AI Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  # workflow_dispatch: {}  # æ‰‹å‹•å®Ÿè¡Œã—ãŸã„å ´åˆã¯æœ‰åŠ¹åŒ–

permissions:
  contents: read
  pull-requests: write
  issues: write   # ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ã«ä½¿ç”¨

env:
  # ãƒãƒªã‚·ãƒ¼ã®å³ã—ã•: block / warn / off
  ENFORCE_LEVEL: block
  # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã“ã®èªãŒã‚ã‚Œã°å¤±æ•—ã‚’ã‚¹ã‚­ãƒƒãƒ—
  OVERRIDE_COMMIT_KEYWORD: "[abap-override]"
  # PRã«ã“ã®ãƒ©ãƒ™ãƒ«ãŒä»˜ã„ã¦ã„ã‚Œã°å¤±æ•—ã‚’ã‚¹ã‚­ãƒƒãƒ—
  OVERRIDE_LABEL: "abap-override"


jobs:
  review:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup jq & gh
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq

      # --- ABAPå·®åˆ†ã®åé›†ï¼ˆABAPæ‹¡å¼µå­ã«é™å®šï¼‰ ---
      - name: Collect ABAP diff
        shell: bash
        run: |
          set -euo pipefail
          git fetch origin "${{ github.base_ref }}" --depth=50
          git diff --unified=0 "origin/${{ github.base_ref }}...HEAD" \
            -- '*.abap' '*.prog.abap' '*.clas.abap' '*.intf.abap' '*.incl.abap' > diff.patch || true
          head -c 90000 diff.patch > diff.trunc.patch || true
          wc -c diff.trunc.patch || true

      # --- å·®åˆ†ãŒç„¡ã‘ã‚Œã°ã‚¹ã‚­ãƒƒãƒ— ---
      - name: Skip if no diff
        id: guard
        shell: bash
        run: |
          if [ ! -s diff.trunc.patch ]; then
            echo "No ABAP diff. Skipping review."
            echo "skip=true" >> "$GITHUB_OUTPUT"
          fi

      # --- PRãƒ¡ã‚¿æƒ…å ±ã®åé›† ---
      - name: Collect PR metadata
        if: steps.guard.outputs.skip != 'true'
        id: meta
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          REPO="${{ github.repository }}"
          NUM="${{ github.event.number }}"
          PR=$(gh api "repos/$REPO/pulls/$NUM")
          FILES_JSON=$(gh api "repos/$REPO/pulls/$NUM/files" -q '.[] | {filename, status}' | jq -c -s .)

          {
            echo "title<<__EOF__"
            echo "$PR" | jq -r '.title'
            echo "__EOF__"
            echo "body<<__EOF__"
            echo "$PR" | jq -r '.body // ""' | tr -d '\r'
            echo "__EOF__"
            echo "author<<__EOF__"
            echo "$PR" | jq -r '.user.login'
            echo "__EOF__"
            echo "changed_files<<__EOF__"
            echo "$FILES_JSON"
            echo "__EOF__"
          } >> "$GITHUB_OUTPUT"

      # --- Dify Workflow å®Ÿè¡Œ ---
      - name: Call Dify Workflow
        if: steps.guard.outputs.skip != 'true'
        id: dify
        env:
          DIFY_API_KEY: ${{ secrets.DIFY_API_KEY }}         # Dify Workflowç”¨ Server-side API Key
          DIFY_API_BASE: ${{ secrets.DIFY_API_BASE }}       # ä¾‹: https://dify-novagrid.com or https://dify-novagrid.com/v1
          DIFY_WORKFLOW_ID: ${{ secrets.DIFY_WORKFLOW_ID }} # ä¾‹: uNCqCaZfykMRl1r6
        shell: bash
        run: |
          set -euo pipefail

          sudo apt-get update -y && sudo apt-get install -y jq

          [ -n "${DIFY_WORKFLOW_ID:-}" ] || { echo "ERROR: DIFY_WORKFLOW_ID is empty."; exit 1; }

          # /v1 ã‚’è£œå®Œ
          _base="${DIFY_API_BASE%/}"
          if ! echo "$_base" | grep -q '/v1$'; then
            _base="$_base/v1"
          fi
          URL="$_base/workflows/run"
          echo "Call URL: $URL"

          # changed_files ã¯â€œæ–‡å­—åˆ—â€ã§æ¸¡ã™ï¼ˆDifyå´ï¼šæ®µè½ 32768ï¼‰
          BODY=$(jq -n \
            --arg wid   "${DIFY_WORKFLOW_ID}" \
            --arg diff  "$(cat diff.trunc.patch)" \
            --arg repo  "${{ github.repository }}" \
            --arg pr    "${{ github.event.number }}" \
            --arg user  "${{ github.actor }}" \
            --arg author "${{ steps.meta.outputs.author }}" \
            --arg title  "${{ steps.meta.outputs.title }}" \
            --arg bodytxt "${{ steps.meta.outputs.body }}" \
            --arg changed_files "${{ steps.meta.outputs.changed_files }}" \
            '{
               workflow_id: $wid,
               inputs: {
                 code_diff: $diff,
                 repo: $repo,
                 pr_number: ($pr|tonumber),
                 author: $author,
                 title: $title,
                 body: $bodytxt,
                 changed_files: $changed_files
               },
               response_mode: "blocking",
               user: $user
             }')

          # æœ¬æ–‡ã¨HTTPã‚³ãƒ¼ãƒ‰ã‚’ä¸¡å–ã‚Šã—ã¦è‡ªå‰åˆ¤å®š
          RESP=$(curl -sS -L -w "\n%{http_code}" \
            -H "Authorization: Bearer $DIFY_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$BODY" \
            "$URL" || true)

          HTTP_CODE=$(echo "$RESP" | tail -n1)
          JSON=$(echo "$RESP" | sed '$d')
          echo "HTTP_CODE=$HTTP_CODE"
          echo "$JSON" > dify.json

          # 2xx åˆ¤å®šã¯ãã®ã¾ã¾å–ã‚Šå‡ºã—ã€é2xxã¯ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ ¼ç´
          if ! echo "$HTTP_CODE" | grep -qE '^2'; then
            echo "(Dify error; HTTP_CODE=$HTTP_CODE)" > review_raw.json
            cat dify.json >> review_raw.json
          else
            # outputs.review ã‚’æœ€å„ªå…ˆã€‚ãªã‘ã‚Œã° outputs å…¨ä½“ã€‚ã•ã‚‰ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§å…¨ä½“ã€‚
            jq -r '
              if .data? and .data.outputs? and (.data.outputs.review? // empty) then
                .data.outputs.review
              elif .review? then
                .review
              elif .data? and .data.outputs? then
                .data.outputs
              else
                .
              end
            ' dify.json > review_raw.json
          fi

          # --- ã“ã“ã‹ã‚‰å …ç‰¢åŒ–ï¼ˆJSONã§ãªã‘ã‚Œã°ç”Ÿãƒ†ã‚­ã‚¹ãƒˆè²¼ã‚Šã«å‚™ãˆã¦ãƒ©ãƒƒãƒ—ï¼‰ ---
          # 1) review_raw.json ãŒã€ŒJSONã¨ã—ã¦å¦¥å½“ã‹ã€ã‚’ç¢ºèª
          if jq -e . review_raw.json >/dev/null 2>&1; then
            # 1-1) JSONã§ã¯ã‚ã‚‹ãŒ "æ–‡å­—åˆ—" ã ã‘ã®ã¨ãã¯ã€JSONã¨ã—ã¦å†ãƒ‘ãƒ¼ã‚¹ã‚’è©¦ã¿ã‚‹
            if jq -e 'type=="string"' review_raw.json >/dev/null 2>&1; then
              # æ–‡å­—åˆ—ãŒã•ã‚‰ã«JSONæ–‡å­—åˆ—ãªã‚‰ãƒ‡ã‚³ãƒ¼ãƒ‰ã€ãƒ€ãƒ¡ãªã‚‰ {raw: "..."} ã«åŒ…ã‚€
              if jq -e 'fromjson | . as $x | ($x|type=="object" or $x|type=="array")' review_raw.json >/dev/null 2>&1; then
                jq -r 'fromjson' review_raw.json > _tmp.json && mv _tmp.json review_raw.json
              else
                jq -r '{raw: .}' review_raw.json > _tmp.json && mv _tmp.json review_raw.json
              fi
            fi
          else
            # 2) ãã‚‚ãã‚‚JSONã§ã¯ãªã„ï¼ˆãƒ—ãƒ¬ãƒ¼ãƒ³æ–‡å­—åˆ—ãªã©ï¼‰â†’ {raw: "..."} ã§åŒ…ã‚€
            jq -R -s '{raw: .}' review_raw.json > _tmp.json && mv _tmp.json review_raw.json
          fi


         # --- æ•´å½¢ã—ã¦ Markdown ã‚’ä½œã‚‹ï¼ˆé‡è¤‡æ’é™¤ï¼‰ ---
      - name: Format Dify output to Markdown
        if: steps.guard.outputs.skip != 'true'
        shell: bash
        run: |
          set -euo pipefail

          # review_raw.json ã¯ã€ŒJSONã®å ´åˆã‚‚ã‚ã‚Œã°ãƒ—ãƒ¬ãƒ¼ãƒ³æ–‡å­—åˆ—ã®å ´åˆã‚‚ã‚ã‚‹ã€ã®ã§
          # -R(=raw) -s(=slurp) ã§"å¸¸ã«æ–‡å­—åˆ—ã¨ã—ã¦"èª­ã¿è¾¼ã‚€ â†’ å¿…è¦ãªã‚‰ fromjson ã§è§£é‡ˆ
          jq -R -s '
            # å—ã‘å–ã£ãŸå€¤ã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆåŒ–ï¼ˆæ–‡å­—åˆ—JSONã«ã‚‚å¯¾å¿œï¼‰
            def ensure_obj($x):
              if ($x|type) == "object" then $x
              elif ($x|type) == "string" then (try ($x|fromjson) catch {"raw":$x})
              else {"raw":($x|tostring)}
              end;

            # è¡¨ç¤ºç”¨ï¼šé‡å¤§åº¦ã®çµµæ–‡å­—
            def sev($s):
              if   $s=="block" then "âŒ block"
              elif $s=="warn"  then "âš ï¸ warn"
              else ($s // "info")
              end;

            . as $raw_text
            | (ensure_obj($raw_text)) as $r

            # Difyã®è¿”ã‚Šå€¤ãŒ {violations:[...], improvements:[...], notes:[...]} å½¢å¼ã§æ¥ã‚‹æƒ³å®š
            # ãã‚Œä»¥å¤–ï¼ˆãƒ—ãƒ¬ãƒ¼ãƒ³æ–‡å­—åˆ—ï¼‰ã¯ {"raw": "..."} ã§å…¥ã£ã¦ã„ã‚‹
            | ($r.violations  // []) as $v_raw
            | ($r.improvements // []) as $i_raw
            | ($r.notes       // []) as $n_raw
            | ($r.raw         // null) as $raw_only

            # --- é‡è¤‡æ’é™¤ ---
            | ($v_raw | (type=="array"    ? unique_by(.rule_id)           : [])) as $viol
            | ($i_raw | (type=="array"    ? unique_by([.title, .code])    : [])) as $impr
            | ($n_raw | (type=="array"    ? unique                        : [])) as $notes

            # --- å‡ºåŠ›ã‚’ä½œã‚‹ ---
            | if (((($viol | length) + ($impr | length) + ($notes | length)) == 0) and ($raw_only != null)) then
            # 1) JSONã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚’è§£é™¤ï¼ˆå¤±æ•—ã—ãŸã‚‰ãã®ã¾ã¾ï¼‰
            ( $raw_only | (try fromjson catch .) )
            # 2) "abap" å˜ç‹¬è¡Œ â†’ ```abap ã«å¤‰æ›ï¼ˆé‡è¤‡ "abap\nabap\n" ã‚‚å¸åï¼‰
            | gsub("\r"; "")
            | gsub("\nabap\nabap\n"; "\n```abap\n")
            | gsub("\nabap\n"; "\n```abap\n")
            # 3) é€£ç¶šã®ç©ºè¡Œã‚’ã€Œã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯çµ‚äº† + æ”¹è¡Œã€ã«å¤‰æ›ï¼ˆç°¡æ˜“ã‚¯ãƒ­ãƒ¼ã‚ºï¼‰
            | gsub("\n\n\n"; "\n```\n\n")
          else
            /* â† ã“ã“ã‹ã‚‰ä¸‹ã¯æ—¢å­˜ã®æ•´å½¢ï¼ˆViolations/Improvements/Notesï¼‰ãã®ã¾ã¾ */
            "### ğŸ¤– Dify ABAP ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ\n"
            + "\n#### ğŸš¨ é•å (Violations)\n"
            + ( if (($viol | length) > 0) then
                  "| ãƒ«ãƒ¼ãƒ«ID | é‡å¤§åº¦ | å ´æ‰€ | å†…å®¹ |\n"
                  + "|----------|--------|------|------|\n"
                  + ( [ $viol[]
                      | "| " + (.rule_id|tostring) + " | "
                      + sev(.severity) + " | "
                      + (.location // "-") + " | "
                      + (.message  // "-") + " |"
                    ] | join("\n") )
                else "_No violations_" end )
            + "\n\n#### ğŸ›  æ”¹å–„ææ¡ˆ (Improvements)\n"
            + ( if (($impr | length) > 0) then
                  ( [ $impr[]
                      | "**" + (.title // "Suggestion") + "**\n"
                      + "èª¬æ˜: " + (.explanation // "-") + "\n"
                      + "```abap\n" + (.code // "") + "\n```\n"
                    ] | join("\n") )
                else "_No suggestions_" end )
            + "\n\n#### ğŸ“ å‚™è€ƒ\n"
            + ( if (($notes | length) > 0)
                then ($notes | map("- " + .) | join("\n"))
                else "_No notes_"
              end )
          end

          ' review_raw.json > review.md

      # --- (ä»»æ„) Blocké•åã‚’ä¸€è¦§ã—ã¦å³Failã•ã›ãŸã„å ´åˆã®å®‰å…¨ç‰ˆ ---
      - name: Fail if block violations exist (with details)
        if: steps.guard.outputs.skip != 'true'
        shell: bash
        run: |
          set -euo pipefail
          # review_raw.json ã‹ã‚‰ block ã®ã¿æŠ½å‡ºï¼ˆç„¡ã‘ã‚Œã°ç©ºé…åˆ—ï¼‰
          jq '[.violations[]? | select(.severity=="block")]' review_raw.json > _blocks.json 2>/dev/null || echo "[]" > _blocks.json
          BLOCK_COUNT=$(jq 'length' _blocks.json)

          # Job Summary ã«è¡¨ã‚’å‡ºã™
          {
            echo "### âŒ Block violations ($BLOCK_COUNT)"
            if [ "$BLOCK_COUNT" -gt 0 ]; then
              echo
              echo "| ãƒ«ãƒ¼ãƒ«ID | å ´æ‰€ | å†…å®¹ |"
              echo "|---|---|---|"
              jq -r '.[] | "| \(.rule_id) | \(.location // "-") | \(.message // "-") |"' _blocks.json
            fi
          } >> "$GITHUB_STEP_SUMMARY"

          # ä»¶æ•°ã§å¤±æ•—
          if [ "$BLOCK_COUNT" -gt 0 ]; then
            echo "âŒ Block violations detected: $BLOCK_COUNT"
            exit 1
          fi


      # --- PRã«ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ ---
      - name: Post PR comment
        if: steps.guard.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          gh api "repos/${{ github.repository }}/issues/${{ github.event.number }}/comments" \
            -f body="$(cat review.md)"

      # --- ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰åˆ¤å®šï¼ˆãƒ©ãƒ™ãƒ«/ã‚³ãƒŸãƒƒãƒˆï¼‰ ---
      - name: Check override (label / commit keyword)
        if: steps.guard.outputs.skip != 'true'
        id: override

        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail

          # blocké•åã‚’æŠ½å‡º
          jq '[.violations[]? | select(.severity=="block")]' review_raw.json > _blocks.json
          BLOCK_COUNT=$(jq 'length' _blocks.json)
      
          # Job Summary ã«è¡¨ã§å‡ºã™ï¼ˆActionsã®Runãƒšãƒ¼ã‚¸ä¸Šã«ã‚¿ãƒ–è¡¨ç¤ºï¼‰
          {
            echo "### âŒ Block violations ($BLOCK_COUNT)"
            if [ "$BLOCK_COUNT" -gt 0 ]; then
              echo
              echo "| ãƒ«ãƒ¼ãƒ«ID | å ´æ‰€ | å†…å®¹ |"
              echo "|---|---|---|"
              jq -r '.[] | "| \(.rule_id) | \(.location // "-") | \(.message // "-") |"' _blocks.json
            fi
          } >> "$GITHUB_STEP_SUMMARY"
      
          # ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚‚å‡ºã™
          cat "$GITHUB_STEP_SUMMARY"
      
          # ä»¶æ•°ã§å¤±æ•—
          if [ "$BLOCK_COUNT" -gt 0 ]; then
            echo "âŒ Block violations detected: $BLOCK_COUNT"
            exit 1

          N="${{ github.event.number }}"
          SKIP=false
          # ãƒ©ãƒ™ãƒ«
          if gh pr view "$N" --json labels -q '.labels[].name' | grep -qx "${OVERRIDE_LABEL}"; then
            echo "Override by label: ${OVERRIDE_LABEL}"
            SKIP=true
          fi
          # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆç›´è¿‘ã‚³ãƒŸãƒƒãƒˆï¼‰
          if git log -1 --pretty=%B | grep -q "${OVERRIDE_COMMIT_KEYWORD}"; then
            echo "Override by commit keyword: ${OVERRIDE_COMMIT_KEYWORD}"
            SKIP=true

          fi
          echo "skip_fail=${SKIP}" >> "$GITHUB_OUTPUT"

      # --- Job Summaryã«Blocké•åã®è©³ç´°ã‚’å‡ºã™ & CIåˆ¶å¾¡ ---
      - name: Enforce policy level (fail if violations)
        if: steps.guard.outputs.skip != 'true' && steps.override.outputs.skip_fail != 'true'
        shell: bash
        run: |
          set -euo pipefail
          # violationsæŠ½å‡ºï¼ˆãªã‘ã‚Œã°ç©ºé…åˆ—ï¼‰
          echo "${{ toJson(steps.dify.outputs) }}" > /dev/null || true  # no-op to keep context
          jq '(.violations // [])' review_raw.json > _viol.json 2>/dev/null || echo "[]" > _viol.json

          level="${ENFORCE_LEVEL:-block}"
          case "$level" in
            off)
              echo "Policy=off â†’ do not fail."
              exit 0
              ;;
            warn)
              FILTER='.[] | select(.severity=="warn" or .severity=="block")'
              ;;
            block|*)
              FILTER='.[] | select(.severity=="block")'
              ;;
          esac

          jq "[ ${FILTER} ]" _viol.json > _sel.json
          COUNT=$(jq 'length' _sel.json)

          {
            echo "### Policy enforcement ($level) â€” selected violations: $COUNT"
            if [ "$COUNT" -gt 0 ]; then
              echo
              echo "| ãƒ«ãƒ¼ãƒ«ID | é‡å¤§åº¦ | å ´æ‰€ | å†…å®¹ |"
              echo "|---|---|---|"
              jq -r '.[] | "| \(.rule_id) | \(.severity) | \(.location // "-") | \(.message // "-") |"' _sel.json
            fi
          } >> "$GITHUB_STEP_SUMMARY"
          cat "$GITHUB_STEP_SUMMARY"



      # --- PRã«ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ ---
      - name: Post PR comment
        if: steps.guard.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          gh api "repos/${{ github.repository }}/issues/${{ github.event.number }}/comments" \
            -f body="$(cat review.md)"

          if [ "$COUNT" -gt 0 ]; then
            echo "âŒ Violations detected under policy=$level: $COUNT"
            exit 1
          fi

