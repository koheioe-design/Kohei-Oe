#
name: ABAP AI Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  # workflow_dispatch: {}  # ÊâãÂãïÂÆüË°å„Åó„Åü„ÅÑÂ†¥Âêà„ÅØÊúâÂäπÂåñ

permissions:
  contents: read
  pull-requests: write
  issues: write

env:
  ENFORCE_LEVEL: block
  OVERRIDE_COMMIT_KEYWORD: "[abap-override]"
  OVERRIDE_LABEL: "abap-override"

jobs:
  review:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup jq
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq

      # --- ABAPÂ∑ÆÂàÜ„ÅÆÂèéÈõÜÔºàABAPÊã°ÂºµÂ≠ê„Å´ÈôêÂÆöÔºâ ---
      - name: Collect ABAP diff
        shell: bash
        run: |
          set -euo pipefail
          git fetch origin "${{ github.base_ref }}" --depth=50
          git diff --unified=0 "origin/${{ github.base_ref }}...HEAD" \
            -- '*.abap' '*.prog.abap' '*.clas.abap' '*.intf.abap' '*.incl.abap' > diff.patch || true
          head -c 90000 diff.patch > diff.trunc.patch || true
          wc -c diff.trunc.patch || true

      # --- Â∑ÆÂàÜ„ÅåÁÑ°„Åë„Çå„Å∞„Çπ„Ç≠„ÉÉ„Éó ---
      - name: Skip if no diff
        id: guard
        shell: bash
        run: |
          if [ ! -s diff.trunc.patch ]; then
            echo "No ABAP diff. Skipping review."
            echo "skip=true" >> "$GITHUB_OUTPUT"
          fi

      # --- PR„É°„ÇøÊÉÖÂ†±„ÅÆÂèéÈõÜ ---
      - name: Collect PR metadata
        if: steps.guard.outputs.skip != 'true'
        id: meta
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          REPO="${{ github.repository }}"
          NUM="${{ github.event.number }}"
          PR=$(gh api "repos/$REPO/pulls/$NUM")
          FILES_JSON=$(gh api "repos/$REPO/pulls/$NUM/files" -q '.[] | {filename, status}' | jq -c -s .)

          {
            echo "title<<__EOF__"
            echo "$PR" | jq -r '.title'
            echo "__EOF__"
            echo "body<<__EOF__"
            echo "$PR" | jq -r '.body // ""' | tr -d '\r'
            echo "__EOF__"
            echo "author<<__EOF__"
            echo "$PR" | jq -r '.user.login'
            echo "__EOF__"
            echo "changed_files<<__EOF__"
            echo "$FILES_JSON"
            echo "__EOF__"
          } >> "$GITHUB_OUTPUT"

      # --- Dify Workflow ÂÆüË°å ---
      - name: Call Dify Workflow
        if: steps.guard.outputs.skip != 'true'
        id: dify
        env:
          DIFY_API_KEY: ${{ secrets.DIFY_API_KEY }}
          DIFY_API_BASE: ${{ secrets.DIFY_API_BASE }}
          DIFY_WORKFLOW_ID: ${{ secrets.DIFY_WORKFLOW_ID }}
        shell: bash
        run: |
          set -euo pipefail


          sudo apt-get update -y && sudo apt-get install -y jq


          [ -n "${DIFY_WORKFLOW_ID:-}" ] || { echo "ERROR: DIFY_WORKFLOW_ID is empty."; exit 1; }

          _base="${DIFY_API_BASE%/}"
          if ! echo "$_base" | grep -q '/v1$'; then
            _base="$_base/v1"
          fi
          URL="$_base/workflows/run"
          echo "Call URL: $URL"


          # changed_files „ÅØ‚ÄúÊñáÂ≠óÂàó‚Äù„ÅßÊ∏°„ÅôÔºàDifyÂÅ¥ÔºöÊÆµËêΩ 32768Ôºâ

          BODY=$(jq -n \
            --arg wid   "${DIFY_WORKFLOW_ID}" \
            --arg diff  "$(cat diff.trunc.patch)" \
            --arg repo  "${{ github.repository }}" \
            --arg pr    "${{ github.event.number }}" \
            --arg user  "${{ github.actor }}" \
            --arg author "${{ steps.meta.outputs.author }}" \
            --arg title  "${{ steps.meta.outputs.title }}" \
            --arg bodytxt "${{ steps.meta.outputs.body }}" \
            --arg changed_files "${{ steps.meta.outputs.changed_files }}" \
            '{
               workflow_id: $wid,
               inputs: {
                 code_diff: $diff,
                 repo: $repo,
                 pr_number: ($pr|tonumber),
                 author: $author,
                 title: $title,
                 body: $bodytxt,
                 changed_files: $changed_files
               },
               response_mode: "blocking",
               user: $user
             }')


          # Êú¨Êñá„Å®HTTP„Ç≥„Éº„Éâ„Çí‰∏°Âèñ„Çä„Åó„Å¶Ëá™ÂâçÂà§ÂÆö

          RESP=$(curl -sS -L -w "\n%{http_code}" \
            -H "Authorization: Bearer $DIFY_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$BODY" \
            "$URL" || true)

          HTTP_CODE=$(echo "$RESP" | tail -n1)
          JSON=$(echo "$RESP" | sed '$d')
          echo "HTTP_CODE=$HTTP_CODE"
          echo "$JSON" > dify.json


          # 2xx Âà§ÂÆö„ÅØ„Åù„ÅÆ„Åæ„ÅæÂèñ„ÇäÂá∫„Åó„ÄÅÈùû2xx„ÅØ„Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÊ†ºÁ¥ç

          if ! echo "$HTTP_CODE" | grep -qE '^2'; then
            echo "(Dify error; HTTP_CODE=$HTTP_CODE)" > review_raw.json
            cat dify.json >> review_raw.json
          else

            # outputs.review „ÇíÊúÄÂÑ™ÂÖà„ÄÇ„Å™„Åë„Çå„Å∞ outputs ÂÖ®‰Ωì„ÄÇ„Åï„Çâ„Å´„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„ÅßÂÖ®‰Ωì„ÄÇ

            jq -r '
              if .data? and .data.outputs? and (.data.outputs.review? // empty) then
                .data.outputs.review
              elif .review? then
                .review
              elif .data? and .data.outputs? then
                .data.outputs
              else
                .
              end
            ' dify.json > review_raw.json
          fi

          # --- „Åì„Åì„Åã„ÇâÂ†ÖÁâ¢ÂåñÔºàJSON„Åß„Å™„Åë„Çå„Å∞Áîü„ÉÜ„Ç≠„Çπ„ÉàË≤º„Çä„Å´ÂÇô„Åà„Å¶„É©„ÉÉ„ÉóÔºâ ---
          # 1) review_raw.json „Åå„ÄåJSON„Å®„Åó„Å¶Â¶•ÂΩì„Åã„Äç„ÇíÁ¢∫Ë™ç
          if jq -e . review_raw.json >/dev/null 2>&1; then
            # 1-1) JSON„Åß„ÅØ„ÅÇ„Çã„Åå "ÊñáÂ≠óÂàó" „Å†„Åë„ÅÆ„Å®„Åç„ÅØ„ÄÅJSON„Å®„Åó„Å¶ÂÜç„Éë„Éº„Çπ„ÇíË©¶„Åø„Çã
            if jq -e 'type=="string"' review_raw.json >/dev/null 2>&1; then
              # ÊñáÂ≠óÂàó„Åå„Åï„Çâ„Å´JSONÊñáÂ≠óÂàó„Å™„Çâ„Éá„Ç≥„Éº„Éâ„ÄÅ„ÉÄ„É°„Å™„Çâ {raw: "..."} „Å´ÂåÖ„ÇÄ
              if jq -e 'fromjson | . as $x | ($x|type=="object" or $x|type=="array")' review_raw.json >/dev/null 2>&1; then
                jq -r 'fromjson' review_raw.json > _tmp.json && mv _tmp.json review_raw.json
              else
                jq -r '{raw: .}' review_raw.json > _tmp.json && mv _tmp.json review_raw.json
              fi
            fi
          else
            # 2) „Åù„ÇÇ„Åù„ÇÇJSON„Åß„ÅØ„Å™„ÅÑÔºà„Éó„É¨„Éº„É≥ÊñáÂ≠óÂàó„Å™„Å©Ôºâ‚Üí {raw: "..."} „ÅßÂåÖ„ÇÄ
            jq -R -s '{raw: .}' review_raw.json > _tmp.json && mv _tmp.json review_raw.json
          fi


      # --- Êï¥ÂΩ¢„Åó„Å¶ Markdown „Çí‰Ωú„ÇãÔºàÈáçË§áÊéíÈô§Ôºâ ---
      - name: Format Dify output to Markdown
        if: steps.guard.outputs.skip != 'true'
        shell: bash
        run: |
          set -euo pipefail


          # jq„Éï„Ç£„É´„Çø„Çí„Éï„Ç°„Ç§„É´„Å´Êõ∏„ÅçÂá∫„ÅôÔºà„Éí„Ç¢„Éâ„Ç≠„É•„É°„É≥„Éà„ÅØÂøÖ„Åö ' ‰ªò„Åç„Åß„ÇØ„Ç©„Éº„ÉàÔºâ
          cat > _format.jq <<'JQ'
          def ensure_obj($x):
            if ($x|type)=="object" then $x
            elif ($x|type)=="string" then (try ($x|fromjson) catch {"raw":$x})
            else {"raw":($x|tostring)}
            end;

          def sev($s):
            if   $s=="block" then "‚ùå block"
            elif $s=="warn"  then "‚ö†Ô∏è warn"
            else ($s // "info")
            end;
          
          . as $txt
          | (ensure_obj($txt)) as $r
          | ($r.violations   // []) as $v_raw
          | ($r.improvements // []) as $i_raw
          | ($r.notes        // []) as $n_raw
          | ($r.raw          // null) as $raw_only
          
          | ($v_raw | if type=="array" then unique_by(.rule_id) else [] end) as $viol
          | ($i_raw | if type=="array" then unique_by([.title,.code]) else [] end) as $impr
          | ($n_raw | if type=="array" then unique else [] end) as $notes
          
          | if (((($viol | length) + ($impr | length) + ($notes | length)) == 0) and ($raw_only != null)) then
              "### ü§ñ Dify ABAP „É¨„Éì„É•„ÉºÁµêÊûú\n\n"
              + "_Parser note: ÈùûÊßãÈÄ†„ÉÜ„Ç≠„Çπ„Éà„ÅÆ„Åü„ÇÅÁîüÊñáË≤º‰ªò_\n\n"
              + $raw_only
            else
              "### ü§ñ Dify ABAP „É¨„Éì„É•„ÉºÁµêÊûú\n"
              + "\n#### üö® ÈÅïÂèç (Violations)\n"
              + ( if (($viol | length) > 0) then
                    "| „É´„Éº„É´ID | ÈáçÂ§ßÂ∫¶ | Â†¥ÊâÄ | ÂÜÖÂÆπ |\n"
                    + "|----------|--------|------|------|\n"
                    + ( [ $viol[]
                        | "| " + (.rule_id|tostring) + " | "
                        + sev(.severity) + " | "
                        + (.location // "-") + " | "
                        + (.message  // "-") + " |"
                      ] | join("\n") )
                  else "_No violations_" end )
              + "\n\n#### üõ† ÊîπÂñÑÊèêÊ°à (Improvements)\n"
              + ( if (($impr | length) > 0) then
                    ( [ $impr[]
                        | "**" + (.title // "Suggestion") + "**\n"
                        + "Ë™¨Êòé: " + (.explanation // "-") + "\n"
                        + "```abap\n" + (.code // "") + "\n```\n"
                      ] | join("\n") )
                  else "_No suggestions_" end )
              + "\n\n#### üìù ÂÇôËÄÉ\n"
              + ( if (($notes | length) > 0)
                  then ($notes | map("- " + .) | join("\n"))
                  else "_No notes_"
                end )
            end

        
          JQ

          # review_raw.json „ÅØ JSON„Åß„ÇÇÁîü„ÉÜ„Ç≠„Çπ„Éà„Åß„ÇÇOK„ÄÇ-R -s „ÅßÂ∏∏„Å´ÊñáÂ≠óÂàó„Å®„Åó„Å¶Ë™≠„ÅøËæº„ÇÄ
          jq -R -s -f _format.jq review_raw.json > review.md

          # review_raw.json „ÅØ„ÄåJSON„ÅÆÂ†¥Âêà„ÇÇ„ÅÇ„Çå„Å∞„Éó„É¨„Éº„É≥ÊñáÂ≠óÂàó„ÅÆÂ†¥Âêà„ÇÇ„ÅÇ„Çã„Äç„ÅÆ„Åß
          # -R(=raw) -s(=slurp) „Åß"Â∏∏„Å´ÊñáÂ≠óÂàó„Å®„Åó„Å¶"Ë™≠„ÅøËæº„ÇÄ ‚Üí ÂøÖË¶Å„Å™„Çâ fromjson „ÅßËß£Èáà
          jq -R -s '
            # Âèó„ÅëÂèñ„Å£„ÅüÂÄ§„Çí„Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÂåñÔºàÊñáÂ≠óÂàóJSON„Å´„ÇÇÂØæÂøúÔºâ
            def ensure_obj($x):
              if ($x|type) == "object" then $x
              elif ($x|type) == "string" then (try ($x|fromjson) catch {"raw":$x})
              else {"raw":($x|tostring)}
              end;

            # Ë°®Á§∫Áî®ÔºöÈáçÂ§ßÂ∫¶„ÅÆÁµµÊñáÂ≠ó
            def sev($s):
              if   $s=="block" then "‚ùå block"
              elif $s=="warn"  then "‚ö†Ô∏è warn"
              else ($s // "info")
              end;

            . as $raw_text
            | (ensure_obj($raw_text)) as $r

            # Dify„ÅÆËøî„ÇäÂÄ§„Åå {violations:[...], improvements:[...], notes:[...]} ÂΩ¢Âºè„ÅßÊù•„ÇãÊÉ≥ÂÆö
            # „Åù„Çå‰ª•Â§ñÔºà„Éó„É¨„Éº„É≥ÊñáÂ≠óÂàóÔºâ„ÅØ {"raw": "..."} „ÅßÂÖ•„Å£„Å¶„ÅÑ„Çã
            | ($r.violations  // []) as $v_raw
            | ($r.improvements // []) as $i_raw
            | ($r.notes       // []) as $n_raw
            | ($r.raw         // null) as $raw_only

            # --- ÈáçË§áÊéíÈô§ ---
            | ($v_raw | (type=="array"    ? unique_by(.rule_id)           : [])) as $viol
            | ($i_raw | (type=="array"    ? unique_by([.title, .code])    : [])) as $impr
            | ($n_raw | (type=="array"    ? unique                        : [])) as $notes

            # --- Âá∫Âäõ„Çí‰Ωú„Çã ---
            | if (((($viol | length) + ($impr | length) + ($notes | length)) == 0) and ($raw_only != null)) then
            # 1) JSON„Ç®„Çπ„Ç±„Éº„Éó„ÇíËß£Èô§ÔºàÂ§±Êïó„Åó„Åü„Çâ„Åù„ÅÆ„Åæ„ÅæÔºâ
            ( $raw_only | (try fromjson catch .) )
            # 2) "abap" ÂçòÁã¨Ë°å ‚Üí ```abap „Å´Â§âÊèõÔºàÈáçË§á "abap\nabap\n" „ÇÇÂê∏ÂèéÔºâ
            | gsub("\r"; "")
            | gsub("\nabap\nabap\n"; "\n```abap\n")
            | gsub("\nabap\n"; "\n```abap\n")
            # 3) ÈÄ£Á∂ö„ÅÆÁ©∫Ë°å„Çí„Äå„Ç≥„Éº„Éâ„Éñ„É≠„ÉÉ„ÇØÁµÇ‰∫Ü + ÊîπË°å„Äç„Å´Â§âÊèõÔºàÁ∞°Êòì„ÇØ„É≠„Éº„Ç∫Ôºâ
            | gsub("\n\n\n"; "\n```\n\n")
          else
            /* ‚Üê „Åì„Åì„Åã„Çâ‰∏ã„ÅØÊó¢Â≠ò„ÅÆÊï¥ÂΩ¢ÔºàViolations/Improvements/NotesÔºâ„Åù„ÅÆ„Åæ„Åæ */
            "### ü§ñ Dify ABAP „É¨„Éì„É•„ÉºÁµêÊûú\n"
            + "\n#### üö® ÈÅïÂèç (Violations)\n"
            + ( if (($viol | length) > 0) then
                  "| „É´„Éº„É´ID | ÈáçÂ§ßÂ∫¶ | Â†¥ÊâÄ | ÂÜÖÂÆπ |\n"
                  + "|----------|--------|------|------|\n"
                  + ( [ $viol[]
                      | "| " + (.rule_id|tostring) + " | "
                      + sev(.severity) + " | "
                      + (.location // "-") + " | "
                      + (.message  // "-") + " |"
                    ] | join("\n") )
                else "_No violations_" end )
            + "\n\n#### üõ† ÊîπÂñÑÊèêÊ°à (Improvements)\n"
            + ( if (($impr | length) > 0) then
                  ( [ $impr[]
                      | "**" + (.title // "Suggestion") + "**\n"
                      + "Ë™¨Êòé: " + (.explanation // "-") + "\n"
                      + "```abap\n" + (.code // "") + "\n```\n"
                    ] | join("\n") )
                else "_No suggestions_" end )
            + "\n\n#### üìù ÂÇôËÄÉ\n"
            + ( if (($notes | length) > 0)
                then ($notes | map("- " + .) | join("\n"))
                else "_No notes_"
              end )
          end

          ' review_raw.json > review.md


      # --- (‰ªªÊÑè) BlockÈÅïÂèç„Çí‰∏ÄË¶ß„Åó„Å¶Âç≥Fail„Åï„Åõ„Åü„ÅÑÂ†¥Âêà„ÅÆÂÆâÂÖ®Áâà ---
      - name: Fail if block violations exist (with details)
        if: steps.guard.outputs.skip != 'true'
        shell: bash
        run: |
          set -euo pipefail
          # review_raw.json „Åã„Çâ block „ÅÆ„ÅøÊäΩÂá∫ÔºàÁÑ°„Åë„Çå„Å∞Á©∫ÈÖçÂàóÔºâ
          jq '[.violations[]? | select(.severity=="block")]' review_raw.json > _blocks.json 2>/dev/null || echo "[]" > _blocks.json
          BLOCK_COUNT=$(jq 'length' _blocks.json)

          # Job Summary „Å´Ë°®„ÇíÂá∫„Åô
          {
            echo "### ‚ùå Block violations ($BLOCK_COUNT)"
            if [ "$BLOCK_COUNT" -gt 0 ]; then
              echo
              echo "| „É´„Éº„É´ID | Â†¥ÊâÄ | ÂÜÖÂÆπ |"
              echo "|---|---|---|"
              jq -r '.[] | "| \(.rule_id) | \(.location // "-") | \(.message // "-") |"' _blocks.json
            fi
          } >> "$GITHUB_STEP_SUMMARY"

          # ‰ª∂Êï∞„ÅßÂ§±Êïó
          if [ "$BLOCK_COUNT" -gt 0 ]; then
            echo "‚ùå Block violations detected: $BLOCK_COUNT"
            exit 1
          fi


      # --- PR„Å´„Ç≥„É°„É≥„ÉàÊäïÁ®ø ---
      - name: Post PR comment
        if: steps.guard.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          gh api "repos/${{ github.repository }}/issues/${{ github.event.number }}/comments" \
            -f body="$(cat review.md)"

      # --- „Ç™„Éº„Éê„Éº„É©„Ç§„ÉâÂà§ÂÆöÔºà„É©„Éô„É´/„Ç≥„Éü„ÉÉ„ÉàÔºâ ---
      - name: Check override (label / commit keyword)
        if: steps.guard.outputs.skip != 'true'
        id: override
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          jq '[.violations[]? | select(.severity=="block")]' review_raw.json > _blocks.json 2>/dev/null || echo "[]" > _blocks.json
          BLOCK_COUNT=$(jq 'length' _blocks.json)

          {
            echo "### ‚ùå Block violations ($BLOCK_COUNT)"
            if [ "$BLOCK_COUNT" -gt 0 ]; then
              echo
              echo "| „É´„Éº„É´ID | Â†¥ÊâÄ | ÂÜÖÂÆπ |"
              echo "|---|---|---|"
              jq -r '.[] | "| \(.rule_id) | \(.location // "-") | \(.message // "-") |"' _blocks.json
            fi
          } >> "$GITHUB_STEP_SUMMARY"
          cat "$GITHUB_STEP_SUMMARY"

          N="${{ github.event.number }}"
          SKIP=false
          if gh pr view "$N" --json labels -q '.labels[].name' | grep -qx "${OVERRIDE_LABEL}"; then
            echo "Override by label: ${OVERRIDE_LABEL}"
            SKIP=true
          fi
          if git log -1 --pretty=%B | grep -q "${OVERRIDE_COMMIT_KEYWORD}"; then
            echo "Override by commit keyword: ${OVERRIDE_COMMIT_KEYWORD}"
            SKIP=true
          fi
          echo "skip_fail=${SKIP}" >> "$GITHUB_OUTPUT"

      # --- Policy enforcement ---
      - name: Enforce policy level (fail if violations)
        if: steps.guard.outputs.skip != 'true' && steps.override.outputs.skip_fail != 'true'
        shell: bash
        run: |
          set -euo pipefail
          jq '(.violations // [])' review_raw.json > _viol.json 2>/dev/null || echo "[]" > _viol.json

          level="${ENFORCE_LEVEL:-block}"
          case "$level" in
            off)  COUNT=0 ;;
            warn) COUNT=$(jq '[ .[] | select(.severity=="warn" or .severity=="block") ] | length' _viol.json) ;;
            block|*) COUNT=$(jq '[ .[] | select(.severity=="block") ] | length' _viol.json) ;;
          esac

          {
            echo "### Policy enforcement ($level) ‚Äî selected violations: $COUNT"
          } >> "$GITHUB_STEP_SUMMARY"
          cat "$GITHUB_STEP_SUMMARY"

          if [ "$COUNT" -gt 0 ]; then
            echo "‚ùå Violations detected under policy=$level: $COUNT"
            exit 1
          fi
